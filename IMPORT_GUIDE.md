# راهنمای درون‌ریزی فایل‌های بزرگ CSV

## مشکل فعلی
فایل شما دارای 61,000 رکورد است اما فقط 12,304 رکورد پردازش می‌شود. این مشکل به دلیل محدودیت‌های سرور و timeout رخ می‌دهد.

## علل احتمالی

### 1. سریال‌های تکراری
احتمالاً بسیاری از سریال‌ها قبلاً در دیتابیس ثبت شده‌اند و سیستم آن‌ها را نادیده می‌گیرد.

### 2. محدودیت‌های سرور
- Timeout در حین پردازش
- محدودیت حافظه
- محدودیت زمان اجرا

## بررسی سریال‌های موجود

قبل از درون‌ریزی، سریال‌های موجود را بررسی کنید:
```bash
php check_existing_serials.php
```

این اسکریپت اطلاعات زیر را نمایش می‌دهد:
- تعداد کل پاداش‌های ثبت شده
- توزیع بر اساس وضعیت
- توزیع بر اساس گروه محصول
- سریال‌های تکراری (اگر وجود داشته باشد)

## راه‌حل‌های پیشنهادی

### 1. تقسیم فایل به قطعات کوچکتر (توصیه شده)

#### استفاده از اسکریپت تقسیم فایل:
```bash
php test_preprocessing.php your_large_file.csv chunk_ 5000
```

این دستور فایل شما را به قطعات 5000 رکوردی تقسیم می‌کند:
- `chunk_001.csv` (5000 رکورد)
- `chunk_002.csv` (5000 رکورد)
- `chunk_003.csv` (5000 رکورد)
- و غیره...

#### تقسیم دستی:
1. فایل CSV را در Excel یا Google Sheets باز کنید
2. فایل را به چندین فایل کوچکتر تقسیم کنید (هر فایل حداکثر 10,000 رکورد)
3. هر فایل را جداگانه درون‌ریزی کنید

### 2. تنظیم اندازه دسته

برای فایل‌های بزرگ، اندازه دسته را کاهش دهید:
- **فایل‌های بزرگ (>10MB):** اندازه دسته = 200-300
- **فایل‌های خیلی بزرگ (>25MB):** اندازه دسته = 100-200
- **فایل‌های عادی:** اندازه دسته = 500

### 3. تنظیمات سرور

با مدیر سرور تماس بگیرید تا این تنظیمات را افزایش دهد:
```ini
max_execution_time = 3600
memory_limit = 4G
post_max_size = 4G
upload_max_filesize = 200M
```

## مراحل درون‌ریزی فایل‌های بزرگ

### مرحله 1: بررسی سریال‌های موجود
```bash
php check_existing_serials.php
```

### مرحله 2: تقسیم فایل
```bash
# برای فایل 61,000 رکوردی
php test_preprocessing.php your_file.csv chunk_ 12000
```

### مرحله 3: درون‌ریزی قطعات
1. به بخش "درون‌ریزی داده‌ها" بروید
2. اندازه دسته را روی 300 تنظیم کنید
3. فایل `chunk_001.csv` را انتخاب کنید
4. روی "شروع درون‌ریزی" کلیک کنید
5. منتظر تکمیل عملیات بمانید
6. همین مراحل را برای سایر قطعات تکرار کنید

### مرحله 4: بررسی نتایج
سیستم حالا آمار دقیق‌تری ارائه می‌دهد:
- **کل رکوردها:** تعداد کل رکوردهای فایل
- **موفق:** رکوردهایی که با موفقیت پردازش شدند
- **ناموفق:** رکوردهایی که با خطا مواجه شدند
- **تکراری:** سریال‌هایی که قبلاً ثبت شده‌اند
- **کاربران ایجاد شده:** کاربران جدید ایجاد شده
- **پاداش‌های ثبت شده:** پاداش‌های جدید ثبت شده

## عیب‌یابی

### خطای 502 Bad Gateway
- اندازه دسته را کاهش دهید
- فایل را به قطعات کوچکتر تقسیم کنید
- با مدیر سرور تماس بگیرید

### خطای Timeout
- اندازه دسته را به 100-200 کاهش دهید
- فایل را به قطعات 5,000 رکوردی تقسیم کنید
- سرور را مجدداً راه‌اندازی کنید

### خطای Memory Limit
- اندازه دسته را کاهش دهید
- حافظه سرور را افزایش دهید
- فایل را به قطعات کوچکتر تقسیم کنید

### تعداد کم رکوردهای پردازش شده
اگر تعداد رکوردهای پردازش شده کم است:
1. سریال‌های موجود را بررسی کنید
2. احتمالاً بسیاری از سریال‌ها تکراری هستند
3. این طبیعی است و مشکلی نیست

## فرمت فایل CSV

فایل CSV باید شامل این ستون‌ها باشد:
```csv
نام کاربری,سریال,گروه,خریدار,کد ملی خریدار,شماره خریدار,تاریخ
```

## نکات مهم

1. **پشتیبان‌گیری:** قبل از درون‌ریزی، از دیتابیس پشتیبان تهیه کنید
2. **تست:** ابتدا با یک فایل کوچک تست کنید
3. **نظارت:** در حین درون‌ریزی، سرور را تحت نظر داشته باشید
4. **تکرار:** اگر خطا رخ داد، دوباره تلاش کنید
5. **تکراری‌ها:** سریال‌های تکراری طبیعی هستند و مشکلی نیستند

## پشتیبانی

در صورت بروز مشکل:
1. لاگ‌های سرور را بررسی کنید
2. با مدیر سرور تماس بگیرید
3. فایل‌های کوچکتر را امتحان کنید
4. سریال‌های موجود را بررسی کنید